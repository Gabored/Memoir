<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style-explorar.css">
    <title>Lista de Hashtags</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<body>
    <div id="header-section">
        <img id="add-hashtag-image" src="..\media\add-hashtag.png" alt="Crear Hashtag" onclick="showCreateHashtagForm()">
        <p id="add-hashtag-message" onclick="showCreateHashtagForm()">Crea tu propio hashtag</p>
    </div>

    <h1>Lista de Hashtags</h1>
    <div id="hashtag-list"></div>
    <table id="memory-table">
        <thead>
            <tr>
                <th>Usuario</th>
                <th>Título</th>
                <th>Descripción</th>
                <th>Media</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se mostrarán las memorias -->
        </tbody>
    </table>

    <!-- Formulario para crear hashtag -->
    <div id="create-hashtag-form">
        <h2>Crea tu propio hashtag</h2>
        <form id="hashtag-form">
            <label for="hashtag-title">Título del Hashtag:</label>
            <input type="text" id="hashtag-title" name="hashtag-title" required>

            <label for="hashtag-image">Link de la Imagen:</label>
            <input type="text" id="hashtag-image" name="hashtag-image" required>

            <button type="button" onclick="createHashtag()">Crear Hashtag</button>
        </form>
    </div>

    <!-- Formulario para editar hashtag -->
    <div id="edit-hashtag-container">
        <h2>Edita tu hashtag</h2>
        <form id="edit-hashtag-form">
            <label for="edit-hashtag-title">Nuevo Título:</label>
            <input type="text" id="edit-hashtag-title" name="edit-hashtag-title" required>

            <label for="edit-hashtag-image">Nuevo Link de la Imagen:</label>
            <input type="text" id="edit-hashtag-image" name="edit-hashtag-image" required>

            <button type="button" onclick="editHashtag()">Guardar Cambios</button>
        </form>
    </div>

    {{#each hashtags}}
        <div class="hashtag-item">
            <img class="hashtag-edit-icon" src="../media/edit.png" alt="Editar Hashtag" onclick="showEditForm('{{this._id}}', '{{this.name}}', '{{this.img}}')">
            <img class="hashtag-img" src="{{this.img}}" alt="{{this.name}}" data-hashtag-id="{{this._id}}">
            <span class="hashtag-name">{{this.name}}</span>
        </div>
    {{/each}}
    
    <script>
    function loadHashtags() {
        let url = 'http://localhost:5001/hashtags';

        $.ajax({
            url: url,
            type: 'GET',
            dataType: 'json',
            success: (data) => {
                let html = '';
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(hashtag => {
                        html += `<div class="hashtag-item">`;
                        html += `<img class="hashtag-img" src="${hashtag.img}" alt="${hashtag.name}" data-hashtag-id="${hashtag._id}">`;
                        html += `<span class="hashtag-name">${hashtag.name}</span>`;
                        html += `</div>`;
                    });
                } else {
                    html = '<p>No se encontraron hashtags</p>';
                }
                $('#hashtag-list').html(html);
                // Agrega el evento click a las imágenes
                $('.hashtag-img').on('click', function() {
                    // Obtiene el _id del hashtag
                    let hashtagId = $(this).attr('data-hashtag-id');
                    // Llama a la función showMemories
                    showMemories(hashtagId);
                });
            },
            error: (xhr, status, error) => {
                console.error('Error al obtener la lista de hashtags:', error);
            }
        });
    }

    function showMemories(hashtagId) {
    let url = 'http://localhost:5001/memorias/searchExplorar/' + hashtagId;

    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        success: (data) => {
        let html = '';
        if (Array.isArray(data) && data.length > 0) {
            data.forEach(memory => {
            html += `<tr>`;
            // Obtener usuario
            $.ajax({
                url: `http://localhost:5001/users/${memory.user}`, // Endpoint para obtener usuario por ID
                type: 'GET',
                dataType: 'json',
                success: (userData) => {
                let username = userData.username;

                html += `<td>${username}</td>`;
                html += `<td>${memory.title}</td>`;
                html += `<td>${memory.body}</td>`;
                html += `<td>`;

                if (Array.isArray(memory.media) && memory.media.length > 0) {
                    memory.media.forEach(media => {
                    html += `<img src="${media}" alt="${memory.title}" width="100px" height="auto">`;
                    });
                }
                html += `</td>`;
                html += `</tr>`;

                // Insertar la fila en la tabla después de completar la llamada AJAX
                $('#memory-table tbody').html(html);
                },
                error: (xhr, status, error) => {
                console.error('Error al obtener el usuario:', error);
                }
            });
            });
        } else {
            html = '<tr><td colspan="4">No se encontraron memorias con el hashtag ' + hashtagId + '</td></tr>';
            $('#memory-table tbody').html(html);
        }
        },
        error: (xhr, status, error) => {
        console.error('Error al obtener las memorias:', error);
        }
    });
    }

    function showCreateHashtagForm() {
            // Muestra el formulario de creación de hashtag
            document.getElementById("create-hashtag-form").style.display = "block";
        }

    function createHashtag() {
        var title = document.getElementById("hashtag-title").value;
        var image = document.getElementById("hashtag-image").value;

        // Validar que los campos no estén vacíos
        if (!title || !image) {
            alert("Por favor, completa todos los campos.");
            return;
        }

        // Datos a enviar al servidor
        var hashtagData = {
            name: title,
            img: image
        };

        // Enviar la solicitud al servidor
        $.ajax({
            url: 'http://localhost:5001/hashtags',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(hashtagData),
            success: function(response) {
                // Manejar la respuesta del servidor, si es necesario
                console.log(response);

                // Opcional: Recargar la lista de hashtags después de crear uno nuevo
                loadHashtags();

                // Ocultar el formulario después de crear el hashtag
                document.getElementById("create-hashtag-form").style.display = "none";
            },
            error: function(xhr, status, error) {
                console.error('Error al crear el hashtag:', error);
                alert('Error al crear el hashtag. Por favor, intenta nuevamente.');
            }
        });
    }

// Función para mostrar el formulario de edición
function showEditForm(hashtagId, currentTitle, currentImage) {
    // Llena el formulario con la información actual del hashtag
    document.getElementById("edit-hashtag-title").value = currentTitle;
    document.getElementById("edit-hashtag-image").value = currentImage;

    // Muestra el formulario de edición
    document.getElementById("edit-hashtag-form").style.display = "block";

    // Guarda el ID del hashtag actualmente en edición
    currentEditingHashtagId = hashtagId;
}

// Variable para almacenar el ID del hashtag que se está editando
var currentEditingHashtagId = null;

// Función para realizar la edición del hashtag
function editHashtag() {
    // Obtiene el ID del hashtag actualmente en edición
    var hashtagId = currentEditingHashtagId;

    // Validar que se haya seleccionado un hashtag para editar
    if (!hashtagId) {
        alert("No se ha seleccionado un hashtag para editar.");
        return;
    }

    var newTitle = document.getElementById("edit-hashtag-title").value;
    var newImage = document.getElementById("edit-hashtag-image").value;

    // Validar que los campos no estén vacíos
    if (!newTitle || !newImage) {
        alert("Por favor, completa todos los campos.");
        return;
    }

    // Datos a enviar al servidor
    var editedHashtagData = {
        name: newTitle,
        img: newImage
    };

    // Realizar la solicitud de actualización al servidor
    $.ajax({
        url: 'http://localhost:5001/hashtags/' + hashtagId, // Asegúrate de tener la URL correcta
        type: 'PUT', // O el método que uses para actualizar en tu backend
        contentType: 'application/json',
        data: JSON.stringify(editedHashtagData),
        success: function(response) {
            // Manejar la respuesta del servidor, si es necesario
            console.log(response);

            // Opcional: Recargar la lista de hashtags después de editar
            loadHashtags();

            // Ocultar el formulario después de guardar cambios
            document.getElementById("edit-hashtag-form").style.display = "none";
        },
        error: function(xhr, status, error) {
            console.error('Error al editar el hashtag:', error);
            alert('Error al editar el hashtag. Por favor, intenta nuevamente.');
        }
    });
}

    // Función para realizar la edición del hashtag
    function editHashtag() {
        var newTitle = document.getElementById("edit-hashtag-title").value;
        var newImage = document.getElementById("edit-hashtag-image").value;

        // Validar que los campos no estén vacíos
        if (!newTitle || !newImage) {
            alert("Por favor, completa todos los campos.");
            return;
        }

        // Datos a enviar al servidor
        var editedHashtagData = {
            name: newTitle,
            img: newImage
        };

        // Realizar la solicitud de actualización al servidor
        $.ajax({
            url: 'http://localhost:5001/hashtags/' + hashtagId, // Asegúrate de tener la URL correcta
            type: 'PUT', // O el método que uses para actualizar en tu backend
            contentType: 'application/json',
            data: JSON.stringify(editedHashtagData),
            success: function(response) {
                // Manejar la respuesta del servidor, si es necesario
                console.log(response);

                // Opcional: Recargar la lista de hashtags después de editar
                loadHashtags();

                // Ocultar el formulario después de guardar cambios
                document.getElementById("edit-hashtag-form").style.display = "none";
            },
            error: function(xhr, status, error) {
                console.error('Error al editar el hashtag:', error);
                alert('Error al editar el hashtag. Por favor, intenta nuevamente.');
            }
        });
    }

    $(function(){
        loadHashtags(); // Carga los hashtags al iniciar la página
    });
    </script>
</body>
</html>
