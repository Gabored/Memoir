<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style-memoria.css">
    <title>Lista de Memorias</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Lista de Memorias</h1>
    <div id="memoria-list"></div>

    <!-- Agrega un cuadro modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <div id="userInfo"></div>
        </div>
    </div>

    <script>
        function loadMemorias() {
            let url = 'http://localhost:5001/memorias';

            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: (data) => {
                    if (Array.isArray(data) && data.length > 0) {
                        $('#memoria-list').empty(); // Limpiar el contenido existente

                        data.forEach(memoria => {
                            const memoriaContainer = $(`<div class="memoria-container" id="memoria-${memoria._id}"></div>`);

                            // Contenedor para las imágenes de la memoria
                            const imagesContainer = $(`<div class="memoria-images"></div>`);

                            // Contenedor para los comentarios de la memoria
                            const comentariosContainer = $(`<div class="comentarios" id="comentarios-${memoria._id}"></div>`);

                            // Agregar el contenedor de la memoria a la lista
                            $('#memoria-list').append(memoriaContainer);

                            // Crear un elemento span para el nombre de usuario
                            const usernameSpan = $(`<span class="clickable-username" data-user-id="${memoria.user}"></span>`);
                            memoriaContainer.append(`<p>Usuario: </p>`);
                            memoriaContainer.find('p').append(usernameSpan);

                            memoriaContainer.append(`<p><strong>${memoria.title}</strong></p>`); // Mostrará el título de la memoria
                            memoriaContainer.append(`<p>${memoria.body}</p>`); // Mostrará el cuerpo de la memoria
                            memoriaContainer.append(`<p><strong>#</strong><span id="hashtag-${memoria._id}"></span></p>`); // Mostrará el hashtag
                            memoriaContainer.append(imagesContainer);
                            memoriaContainer.append(comentariosContainer);

                            // Obtener imágenes de la memoria
                            $.ajax({
                                url: `http://localhost:5001/medias/${memoria.media}`,
                                type: 'GET',
                                dataType: 'json',
                                success: (mediaPaths) => {
                                    const imagesHtml = mediaPaths.map(path => `<img src="${path}" alt="Memoria ${memoria._id}">`);
                                    imagesContainer.html(imagesHtml.join(''));
                                },
                                error: (xhr, status, error) => {
                                    console.error('Error al obtener las imágenes de la memoria:', error);
                                }
                            });

                            // Obtener comentarios por memoria
                            $.ajax({
                                url: `http://localhost:5001/comments/post/${memoria._id}`,
                                type: 'GET',
                                dataType: 'json',
                                success: (comments) => {
                                    let comentariosHtml = '';
                                    if (Array.isArray(comments) && comments.length > 0) {
                                        comentariosHtml += `<p>Comentarios:</p><ul>`;
                                        comments.forEach(comment => {
                                            $.ajax({
                                                url: `http://localhost:5001/users/${comment.writer_user}`,
                                                type: 'GET',
                                                dataType: 'json',
                                                success: (userData) => {
                                                    const comentarioHTML = `<li>${userData.username}: ${comment.body}</li>`;
                                                    comentariosContainer.append(comentarioHTML);
                                                },
                                                error: (xhr, status, error) => {
                                                    console.error('Error al obtener el usuario del comentario:', error);
                                                }
                                            });
                                        });
                                        comentariosHtml += `</ul>`;
                                    } else {
                                        comentariosHtml = '<p>Sé el primero en comentar esta memoria...</p>';
                                    }
                                    comentariosContainer.html(comentariosHtml);
                                },
                                error: (xhr, status, error) => {
                                    console.error('Error al obtener los comentarios de la memoria:', error);
                                }
                            });

                            // Obtener Hashtags
                            const hashtagsContainer = $(`#hashtag-${memoria._id}`);
                            memoria.hashtag.forEach((hashtagId, index) => {
                                $.ajax({
                                    url: `http://localhost:5001/hashtags/${hashtagId}`,
                                    type: 'GET',
                                    dataType: 'json',
                                    success: (hashtagData) => {
                                        hashtagsContainer.append(`<span>${hashtagData.name}</span>`);
                                        if (index < memoria.hashtag.length - 1) {
                                            // Si no es el último hashtag, añadir una coma
                                            hashtagsContainer.append(' <strong>#</strong>');
                                        }
                                    },
                                    error: (xhr, status, error) => {
                                        console.error('Error al obtener el hashtag:', error);
                                    }
                                });
                            });

                            // Obtener Usuario
                            $.ajax({
                                url: `http://localhost:5001/users/${memoria.user}`,
                                type: 'GET',
                                dataType: 'json',
                                success: (userData) => {
                                    // Actualizar el texto del nombre de usuario
                                    usernameSpan.text(userData.username);

                                    // Agregar el evento de clic al nombre de usuario
                                    usernameSpan.addClass('clickable-username').attr('data-user-id', memoria.user);
                                },
                                error: (xhr, status, error) => {
                                    console.error('Error al obtener el usuario:', error);
                                }
                            });
                        });
                    } else {
                        $('#memoria-list').html('<p>No se encontraron memorias</p>');
                    }
                },
                error: (xhr, status, error) => {
                    console.error('Error al obtener la lista de memorias:', error);
                }
            });
        }

        $(document).ready(function(){
            loadMemorias();

            // Agrega un evento de clic al nombre de usuario
            $(document).on('click', '.clickable-username', function() {
                const userId = $(this).data('user-id');
                mostrarVentanaUsuario(userId);
            });

            // Agrega un evento de clic al botón de cierre del modal
            $('#closeModal').on('click', function() {
                cerrarModal();
            });
        });

        function mostrarVentanaUsuario(userId) {
            // Hacer una solicitud AJAX para obtener los datos del usuario
            $.ajax({
                url: `http://localhost:5001/users/${userId}`,
                type: 'GET',
                dataType: 'json',
                success: (userData) => {
                    // Construir el contenido del modal con la información del usuario
                    const userInfoHtml = `
                        <p><strong>Nombre:</strong> ${userData.name}</p>
                        <p><strong>Apellido:</strong> ${userData.surname}</p>
                        <p><strong>Correo Electrónico:</strong> ${userData.email || 'No disponible'}</p>
                        <p><strong>Ubicación:</strong> ${userData.location || 'No disponible'}</p>
                        <p><strong>Intereses:</strong> ${userData.interests || 'No disponible'}</p>
                        <!-- Agrega más campos según sea necesario -->
                    `;

                    // Mostrar la información en el modal
                    $('#userInfo').html(userInfoHtml);
                    abrirModal();
                },
                error: (xhr, status, error) => {
                    console.error('Error al obtener los datos del usuario:', error);
                }
            });
        }

        function abrirModal() {
            // Mostrar el modal
            $('#myModal').css('display', 'block');
        }

        function cerrarModal() {
            // Cerrar el modal
            $('#myModal').css('display', 'none');
        }
    </script>
</body>
</html>
